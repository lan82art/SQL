SELECT --TOP 100
  НП.Наименование AS НП,НПР.Наименование AS Район,НПРР.Наименование AS Область
  --НП.Ссылка AS [НП $Справочник.НаселенныеПункты]
	--,НПР.Ссылка AS [Район $Справочник.НаселенныеПункты]
	--,НПРР.Ссылка AS [Область $Справочник.НаселенныеПункты]
	--,Товар.Наименование
  --,Товар.ЕдиницаИзмерения
	--,Товар.Флаг
	--,SUM(ТабличнаяЧасть.Кво) as Кво
	,SUM(ТабличнаяЧасть.Сумма) as Сумма
FROM
	[_1SJourn] Жур (nolock)
INNER JOIN
	[ТЧЗаказ] as ТабличнаяЧасть (nolock) ON ТабличнаяЧасть.Ссылка=Жур.IDDoc
LEFT JOIN 
	[СпрТовары] as Товар (nolock) ON Товар.Ссылка=ТабличнаяЧасть.Товар
--LEFT JOIN 
--	[ДокРасходнаяНакладная] as РН (nolock) ON РН.Заказ=Жур.IDDoc
INNER JOIN 
	[ДокЗаказ] as Заказ (nolock) ON Заказ.Ссылка=Жур.IDDoc
INNER JOIN 
	[СпрКонтрагенты] as Клиент (nolock) ON Клиент.Ссылка=Заказ.Контрагент
INNER JOIN 
	[СпрНаселенныеПункты] as НП (nolock) ON НП.Ссылка=Клиент.НаселенныйПункт
INNER JOIN 
	[СпрНаселенныеПункты] as НПР (nolock) ON НПР.Ссылка=НП.Родитель
INNER JOIN 
	[СпрНаселенныеПункты] as НПРР (nolock) ON НПРР.Ссылка=НПР.Родитель
INNER JOIN 
	[СпрСтатусЗаказа] as СтатусЗаказа (nolock) ON СтатусЗаказа.Ссылка=Заказ.Статус
WHERE
	Жур.Date_Time_IDDoc BETWEEN '20170619' AND '20170619Z'
	AND Жур.IDDocDef = 67 
	AND Жур.Closed & 1 = 1
	AND Товар.Флаг>0
	AND Клиент.ЧерныйСписок=0
	AND СтатусЗаказа.Ссылка <> '4'
	--GROUP BY НП.Ссылка, НПР.Ссылка, НПРР.Ссылка
  GROUP BY НП.Наименование, НПР.Наименование, НПРР.Наименование
